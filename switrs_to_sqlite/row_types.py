from collections.abc import Sequence

import switrs_to_sqlite.make_map as mm
import switrs_to_sqlite.value_maps as vm
from switrs_to_sqlite.converters import (
    cellphone_use_to_bool,
    convert,
    county_city_location_to_county,
    negative,
    non_standard_str_to_bool,
    string_to_bool,
)
from switrs_to_sqlite.datatypes import DataType
from switrs_to_sqlite.schema import Column

# Type alias for date field definitions (kept as tuples - simpler structure)
DateFieldDefinition = tuple[int, str, DataType]
DateParsingTable = tuple[DateFieldDefinition, ...]

DEFAULT_NULLS: set[str] = {"", "-"}

COLLISION_ROW: Sequence[Column] = (
    Column(
        index=0,
        name="case_id",
        sql_type=DataType.TEXT,
        nulls=None,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=3,
        name="jurisdiction",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=6,
        name="officer_id",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=7,
        name="reporting_district",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=9,
        name="chp_shift",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.CHP_SHIFT,
    ),
    Column(
        index=10,
        name="population",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.POPULATION,
    ),
    Column(
        index=11,
        name="county_city_location",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=11,
        name="county_location",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=county_city_location_to_county,
        mapping=vm.COUNTIES,
    ),
    Column(
        index=12,
        name="special_condition",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=13,
        name="beat_type",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.BEAT_TYPE,
    ),
    Column(
        index=14,
        name="chp_beat_type",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.CHP_BEAT_TYPE,
    ),
    Column(
        index=15,
        name="city_division_lapd",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS | {"0"},
        converter=convert,
        mapping=None,
    ),
    Column(
        index=16,
        name="chp_beat_class",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.CHP_BEAT_CLASS,
    ),
    Column(
        index=17,
        name="beat_number",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=18,
        name="primary_road",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=19,
        name="secondary_road",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=20,
        name="distance",
        sql_type=DataType.REAL,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=21,
        name="direction",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.DIRECTION,
    ),
    Column(
        index=22,
        name="intersection",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=string_to_bool,
        mapping=None,
    ),
    Column(
        index=23,
        name="weather_1",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS | {"N", "Y"},
        converter=convert,
        mapping=vm.WEATHER,
    ),
    Column(
        index=24,
        name="weather_2",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS | {"N", "Y"},
        converter=convert,
        mapping=vm.WEATHER,
    ),
    Column(
        index=25,
        name="state_highway_indicator",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=string_to_bool,
        mapping=None,
    ),
    Column(
        index=26,
        name="caltrans_county",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.CALTRANS_COUNTY,
    ),
    Column(
        index=27,
        name="caltrans_district",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=28,
        name="state_route",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=29,
        name="route_suffix",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=30,
        name="postmile_prefix",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=31,
        name="postmile",
        sql_type=DataType.REAL,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=32,
        name="location_type",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.LOCATION_TYPE,
    ),
    Column(
        index=33,
        name="ramp_intersection",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.RAMP_INTERSECTION,
    ),
    Column(
        index=34,
        name="side_of_highway",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.SIDE_OF_HIGHWAY,
    ),
    Column(
        index=35,
        name="tow_away",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=string_to_bool,
        mapping=None,
    ),
    Column(
        index=36,
        name="collision_severity",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.COLLISION_SEVERITY,
    ),
    Column(
        index=37,
        name="killed_victims",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=38,
        name="injured_victims",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=39,
        name="party_count",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=40,
        name="primary_collision_factor",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.PRIMARY_COLLISION_FACTOR,
    ),
    Column(
        index=41,
        name="pcf_violation_code",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.PCF_VIOLATION_CODE,
    ),
    Column(
        index=42,
        name="pcf_violation_category",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.PCF_VIOLATION_CATEGORY,
    ),
    Column(
        index=43,
        name="pcf_violation",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=44,
        name="pcf_violation_subsection",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=45,
        name="hit_and_run",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.HIT_AND_RUN,
    ),
    Column(
        index=46,
        name="type_of_collision",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS | {"M"},
        converter=convert,
        mapping=vm.COLLISION_TYPE,
    ),
    Column(
        index=47,
        name="motor_vehicle_involved_with",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.INVOLVED_WITH,
    ),
    Column(
        index=48,
        name="pedestrian_action",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.PEDESTRIAN_ACTION,
    ),
    Column(
        index=49,
        name="road_surface",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.ROAD_SURFACE,
    ),
    Column(
        index=50,
        name="road_condition_1",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.ROAD_CONDITION,
    ),
    Column(
        index=51,
        name="road_condition_2",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.ROAD_CONDITION,
    ),
    Column(
        index=52,
        name="lighting",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.LIGHTING,
    ),
    Column(
        index=53,
        name="control_device",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.CONTROL_DEVICE,
    ),
    Column(
        index=54,
        name="chp_road_type",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=55,
        name="pedestrian_collision",
        sql_type=DataType.INTEGER,
        nulls=None,
        converter=string_to_bool,
        mapping=None,
    ),
    Column(
        index=56,
        name="bicycle_collision",
        sql_type=DataType.INTEGER,
        nulls=None,
        converter=string_to_bool,
        mapping=None,
    ),
    Column(
        index=57,
        name="motorcycle_collision",
        sql_type=DataType.INTEGER,
        nulls=None,
        converter=string_to_bool,
        mapping=None,
    ),
    Column(
        index=58,
        name="truck_collision",
        sql_type=DataType.INTEGER,
        nulls=None,
        converter=string_to_bool,
        mapping=None,
    ),
    Column(
        index=59,
        name="not_private_property",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=string_to_bool,
        mapping=None,
    ),
    Column(
        index=60,
        name="alcohol_involved",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=string_to_bool,
        mapping=None,
    ),
    Column(
        index=61,
        name="statewide_vehicle_type_at_fault",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.STATEWIDE_VEHICLE_TYPE,
    ),
    Column(
        index=62,
        name="chp_vehicle_type_at_fault",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.CHP_VEHICLE_TYPE,
    ),
    Column(
        index=63,
        name="severe_injury_count",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=64,
        name="other_visible_injury_count",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=65,
        name="complaint_of_pain_injury_count",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=66,
        name="pedestrian_killed_count",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=67,
        name="pedestrian_injured_count",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=68,
        name="bicyclist_killed_count",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=69,
        name="bicyclist_injured_count",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=70,
        name="motorcyclist_killed_count",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=71,
        name="motorcyclist_injured_count",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=72,
        name="primary_ramp",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.RAMP_TYPE,
    ),
    Column(
        index=73,
        name="secondary_ramp",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.RAMP_TYPE,
    ),
    Column(
        index=74,
        name="latitude",
        sql_type=DataType.REAL,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=75,
        name="longitude",
        sql_type=DataType.REAL,
        nulls=DEFAULT_NULLS,
        converter=negative,
        mapping=None,
    ),
)

COLLISION_DATE_TABLE: DateParsingTable = (
    (4, "collision_date", DataType.TEXT),
    (5, "collision_time", DataType.TEXT),
    (2, "process_date", DataType.TEXT),
)

PARTY_ROW: Sequence[Column] = (
    Column(
        index=0,
        name="case_id",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=1,
        name="party_number",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=2,
        name="party_type",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.PARTY_TYPE,
    ),
    Column(
        index=3,
        name="at_fault",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=string_to_bool,
        mapping=None,
    ),
    Column(
        index=4,
        name="party_sex",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.SEX,
    ),
    Column(
        index=5,
        name="party_age",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS | {"998"},
        converter=convert,
        mapping=None,
    ),
    Column(
        index=6,
        name="party_sobriety",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.SOBRIETY,
    ),
    Column(
        index=7,
        name="party_drug_physical",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.DRUG,
    ),
    Column(
        index=8,
        name="direction_of_travel",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.DIRECTION,
    ),
    Column(
        index=9,
        name="party_safety_equipment_1",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.SAFETY,
    ),
    Column(
        index=10,
        name="party_safety_equipment_2",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.SAFETY,
    ),
    Column(
        index=11,
        name="financial_responsibility",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.FINANCIAL,
    ),
    Column(
        index=12,
        name="hazardous_materials",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=non_standard_str_to_bool,
        mapping=None,
    ),
    Column(
        index=13,
        name="cellphone_in_use",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=cellphone_use_to_bool,
        mapping=None,
    ),
    Column(
        index=13,
        name="cellphone_use_type",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.CELLPHONE_USE_TYPE,
    ),
    Column(
        index=14,
        name="school_bus_related",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=non_standard_str_to_bool,
        mapping=None,
    ),
    Column(
        index=15,
        name="oaf_violation_code",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.OAF_VIOLATION_CODE,
    ),
    Column(
        index=16,
        name="oaf_violation_category",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS | {"00"},
        converter=convert,
        mapping=vm.OAF_VIOLATION_CATEGORY,
    ),
    Column(
        index=17,
        name="oaf_violation_section",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=18,
        name="oaf_violation_suffix",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=19,
        name="other_associate_factor_1",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.OTHER_FACTOR,
    ),
    Column(
        index=20,
        name="other_associate_factor_2",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.OTHER_FACTOR,
    ),
    Column(
        index=21,
        name="party_number_killed",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=22,
        name="party_number_injured",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=23,
        name="movement_preceding_collision",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.MOVEMENT_PRECEDING,
    ),
    Column(
        index=24,
        name="vehicle_year",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS | {"9999"},
        converter=convert,
        mapping=None,
    ),
    Column(
        index=25,
        name="vehicle_make",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=mm.MAKE_MAP,
    ),
    Column(
        index=26,
        name="statewide_vehicle_type",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.STATEWIDE_VEHICLE_TYPE,
    ),
    Column(
        index=27,
        name="chp_vehicle_type_towing",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.CHP_VEHICLE_TYPE,
    ),
    Column(
        index=28,
        name="chp_vehicle_type_towed",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.CHP_VEHICLE_TYPE,
    ),
    Column(
        index=29,
        name="party_race",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.RACE,
    ),
)

VICTIM_ROW: Sequence[Column] = (
    Column(
        index=0,
        name="case_id",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=1,
        name="party_number",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=None,
    ),
    Column(
        index=2,
        name="victim_role",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.ROLE,
    ),
    Column(
        index=3,
        name="victim_sex",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.SEX,
    ),
    Column(
        index=4,
        name="victim_age",
        sql_type=DataType.INTEGER,
        nulls=DEFAULT_NULLS | {"998"},
        converter=convert,
        mapping=None,
    ),
    Column(
        index=5,
        name="victim_degree_of_injury",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.DEGREE_OF_INJURY,
    ),
    Column(
        index=6,
        name="victim_seating_position",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.SEATING_POSITION,
    ),
    Column(
        index=7,
        name="victim_safety_equipment_1",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.SAFETY,
    ),
    Column(
        index=8,
        name="victim_safety_equipment_2",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.SAFETY,
    ),
    Column(
        index=9,
        name="victim_ejected",
        sql_type=DataType.TEXT,
        nulls=DEFAULT_NULLS,
        converter=convert,
        mapping=vm.EJECTED,
    ),
)
